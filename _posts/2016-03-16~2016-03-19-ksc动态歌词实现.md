---
layout: post
title: ksc动态歌词实现
---

# lrc 歌词格式 #
lrc歌词：`[00:30.06]从前我太适应悲伤`
 
|  内容            |     备注       |       分析                                                          |
| -------------    |-------------   | -----                                                              |
| 00:30.06         |   歌词出现时间  | 分：秒.毫秒，此次毫秒并不是真正意义上的毫秒，它表示的是00分30秒60（06*10）毫秒 |
| 从前我太适应悲伤  |   歌词内容      |                                                                      |

从lrc歌词的内容格式，可以看到lrc歌词只是精确到行歌词

# ksc 歌词格式 #
ksc歌词：`karaoke.add('00:30.600', '00:36.400', '从前我太适应悲伤', '367,538,1742,425,230,481,529,1488')`

|  内容            |     备注            |          分析                                             |
| -------------    |------------        | -----                                                     |
| 00:30.600         |   歌词出现时间    | 分：秒.毫秒，此次毫秒是真正意义上的毫秒，它表示的是00分30秒600毫秒 |
| 00:36.400         |   歌词出现时间   | 分：秒.毫秒，此次毫秒是真正意义上的毫秒，它表示的是00分36秒400毫秒 |
| 从前我太适应悲伤   |   歌词内容           |                                                        |
|367,538,1742,425,230,481,529,1488|每个歌词对应的时间|单位：毫秒|

从ksc歌词内容格式，可以看到ksc歌词是可以精确到每个歌词的时间

# 思路分析 #
- 各个页面间的通讯<br>
音乐播放器有一个问题，就是只有一个地方播放歌曲，这个歌曲信息或者歌曲进度却要通知不止一个页面，可能是多个页面，这时我们应该怎么办呢。不怕，我们可以用`观察者模式`来实现，该模式适应于java和android，在android中也可以用广播来代替。
- ksc歌词显示效果<br>
ktv动态歌词的效果，如果是对api比较了解的，就可以知道，它主要是通过clip剪裁来实现的，具体效果如图所示：<br>
![](http://i.imgur.com/h5CD2gm.png)
由上图可以看出，我们主要在对应的时间，设置好clip层的矩形大小，我们便可以看到我们想要的ktv动态歌词效果。
- ksc歌词上下滚动、歌词字体缩放<br>
1. 歌词的上下滚动，高亮歌词应一直显示在视图的中间位置，这一点是确定的。现在情况是高亮的A行歌词，与准备高亮的B行歌词准备显示，B行歌词到高亮时，要经过从B慢慢上移到A行的位置，当然A行歌词也随着上移，B上移到A的总距离为s，默认B上移到A的时间为`t = Math.min(300, (该行歌词结束时间 - 该行歌词开始时间) / 2)`，即是该行歌词显示的时间长度的一半，如果大于300ms，则取300ms。计算出`v = s/t`，v则是歌词每秒上移的距离，我们可通过当前歌曲的播放时间m来计算，已经播放了的时间`t1 = m - 该行歌词开始时间`，最后，计算该行歌词要上移的距离` dy = t1 * v`，这个dy的距离也是整体歌词要移动的距离。
2. 歌词字体缩放，就是歌词在上下滚动的过程中，歌词的字体大小由正常大小d变成高亮的大小h（`d-->h`）,在由d变到h的过程中，字体因子`m = dy / d`，我们在歌词绘画的过程，要记录当前高亮歌词A行，和下一行准备高亮的歌词B行，A行歌词由`h-->d`公式为：`(textSize = h - (h - d) * m)`，B行歌词由`d-->h`公式为：`(textSize = d + (h - d)* m)`，这样便有缩放的效果了。
- ksc歌词超过屏幕宽度移动<br>
歌词超过屏幕宽度移动，原理简单，当歌词长度超过屏幕宽度时，只要在绘画歌词的时候，不断修改该行歌词的X轴位置就可以了。
- ksc歌词定位播放<br>
ksc歌词定位播放功能就是通过滑动歌词，从而达到歌曲定位播放的效果，我们播放歌曲，就是用一个线程播放歌曲(当然，音频文件的解码等等我们先不理，初学者一般选择一些集成的播放类如：android的MediaPlayer等)，每隔100ms(毫秒)去更新进度条。而歌词定位就刚好相反，我们歌词滑动，就相当是一个线程，歌词每滑动距离单位 1 ，则歌曲快进/后退 100 ms。这样就实现了歌词控件歌曲的定位播放了。

# 实现效果图 #
- java swing 版本<br>
![](http://i.imgur.com/Yy1gJts.png)

- android 版本<br>
![](http://i.imgur.com/M4A1oCu.png)

# java swing版本音乐播放器代码 #
https://github.com/zhangliangming/HappyPlayer-PC-musique.git
# android版本音乐播放器代码 #
https://github.com/zhangliangming/HappyPlayer2015-09-06-new.git